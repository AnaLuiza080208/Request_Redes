<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executor de C√≥digo Python</title>
    <link rel="stylesheet" href="judge.css">
</head>
<body>

    <div class="container">
        <h2>üêç C√≥digo Python</h2>
        <div class="quadrado" style="padding-top: 0;">
            <pre id="bloco-codigo" contenteditable="true">a = int(input())
b = int(input())
print(a + b)</pre>
        </div>

        <h2>üì• Entrada (stdin)</h2>
        <div class="quadrado">
            <textarea id="stdin-input" placeholder="Digite a entrada aqui...">3
5</textarea>
        </div>

        <h2>üéØ Sa√≠da esperada</h2>
        <div class="quadrado">
            <textarea id="expected-output" placeholder="Digite a sa√≠da esperada aqui...">8</textarea>
        </div>

        <button id="run-button">Executar</button>

        <h2>üöÄ Resultado</h2>
        <div class="quadrado">
            <pre id="output-box">Clique em 'Executar' para ver o resultado...</pre>
        </div>
    </div>

    <script>
        const JUDGE0_URL = "http://judge.darlon.com.br";
        const url = `${JUDGE0_URL}/submissions?base64_encoded=true&wait=true`;

        const runButton = document.getElementById("run-button");
        const codeBlock = document.getElementById("bloco-codigo");
        const stdinInput = document.getElementById("stdin-input");
        const expectedOutputInput = document.getElementById("expected-output");
        const outputBox = document.getElementById("output-box");

        // Fun√ß√µes para convers√£o Base64 com suporte a UTF-8
        function utf8_to_b64(str) {
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error("Erro ao codificar para Base64:", e);
                return "";
            }
        }

        function b64_to_utf8(str) {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                console.error("Erro ao decodificar de Base64:", e);
                return "";
            }
        }

        // Fun√ß√£o de compara√ß√£o e c√°lculo de porcentagem de acerto
        function compararSaida(saida, esperado) {
            saida = saida.trim();
            esperado = esperado.trim();

            if (saida === esperado) {
                return { acerto: 100, mensagem: "‚úÖ Sa√≠da correta!" };
            }

            let minLength = Math.min(saida.length, esperado.length);
            let acertos = 0;
            for (let i = 0; i < minLength; i++) {
                if (saida[i] === esperado[i]) acertos++;
            }

            const porcentagem = ((acertos / esperado.length) * 100).toFixed(2);
            return {
                acerto: porcentagem,
                mensagem: `‚ùå Sa√≠da incorreta (${porcentagem}% de acerto)`
            };
        }

        async function submitCode() {
            const source_code = codeBlock.innerText;
            const stdin = stdinInput.value;
            const expected = expectedOutputInput.value;

            outputBox.style.color = "#ffff99";
            outputBox.innerText = "Enviando submiss√£o... Aguarde...";
            runButton.disabled = true;
            runButton.innerText = "Executando...";

            const encoded_source = utf8_to_b64(source_code);
            const encoded_stdin = utf8_to_b64(stdin);

            const payload = {
                source_code: encoded_source,
                language_id: 71,
                stdin: encoded_stdin,
                base64_encoded: true,
                wait: true
            };

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);

                const result = await response.json();

                const stdout = b64_to_utf8(result.stdout || "").trim();
                const stderr = b64_to_utf8(result.stderr || "").trim();
                const status = result.status?.description || "Status desconhecido";

                const comparacao = compararSaida(stdout, expected);

                // Define cor com base no acerto
                outputBox.style.color = comparacao.acerto == 100 ? "#99ff99" : "#ff9999";

                outputBox.innerText =
                    `Status: ${status}\n\n` +
                    `--- Sa√≠da Padr√£o (stdout) ---\n${stdout || "(vazio)"}\n\n` +
                    `--- Erros (stderr) ---\n${stderr || "Nenhum"}\n\n` +
                    `--- Compara√ß√£o ---\n${comparacao.mensagem}\n` +
                    `Esperado: "${expected}"\nObtido:  "${stdout}"`;

            } catch (error) {
                console.error("Erro ao fazer a requisi√ß√£o:", error);
                outputBox.style.color = "#ff9999";
                outputBox.innerText = `‚ùå Erro ao fazer a requisi√ß√£o:\n${error.message}`;
            } finally {
                runButton.disabled = false;
                runButton.innerText = "Executar";
            }
        }

        runButton.addEventListener("click", submitCode);
    </script>

</body>
</html>
